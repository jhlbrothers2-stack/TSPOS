<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TSPOS Starter</title>
  <style>
    body {
      margin: 0;
      font-family: monospace;
      background-color: #1e1e1e;
      color: #ccc;
    }
    #terminal-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #terminal-output {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      white-space: pre-wrap;
    }
    #terminal-input {
      border: none;
      padding: 10px;
      font-family: inherit;
      font-size: 16px;
      width: 100%;
      color: #fff;
      background: #111;
      outline: none;
    }
  </style>
</head>
<body>
  <div id="terminal-container">
    <div id="terminal-output"></div>
    <input id="terminal-input" type="text" autocomplete="off" autofocus />
  </div>

  <script>
    const outputEl = document.getElementById("terminal-output");
    const inputEl = document.getElementById("terminal-input");
    const commands = {};
    const fs = {
      root: { },
      cwd: "/",
      normalize(path) {
        const parts = path.split("/").filter(Boolean);
        const stack = [];
        for (const part of parts) {
          if (part === "..") stack.pop();
          else if (part !== ".") stack.push(part);
        }
        return "/" + stack.join("/");
      },
      getNode(path) {
        const parts = fs.normalize(path).split("/").filter(Boolean);
        let node = fs.root;
        for (const part of parts) {
          if (!(part in node)) return null;
          node = node[part];
        }
        return node;
      },
      setNode(path, value) {
        const parts = fs.normalize(path).split("/").filter(Boolean);
        let node = fs.root;
        for (let i = 0; i < parts.length - 1; i++) {
          const part = parts[i];
          if (!(part in node)) node[part] = {};
          node = node[part];
        }
        node[parts.at(-1)] = value;
      },
      exists(path) {
        return fs.getNode(path) !== null;
      },
      ls(path) {
        const node = fs.getNode(path);
        return node && typeof node === "object" ? Object.keys(node) : [];
      }
    };

    const print = (...lines) => {
      lines.forEach(line => {
        outputEl.innerHTML += line + "\n";
      });
      outputEl.scrollTop = outputEl.scrollHeight;
    };

    const resolvePath = (path) => {
      if (!path || path === ".") return fs.cwd;
      if (path === "..") {
        const parts = fs.cwd.split("/").filter(Boolean);
        parts.pop();
        return "/" + parts.join("/");
      }
      return path.startsWith("/") ? fs.normalize(path) : fs.normalize(fs.cwd + "/" + path);
    };

    commands.help = {
      desc: "Show available commands",
      fn(args) {
        print("Available commands:\n" +
          Object.keys(commands)
            .map(cmd => "  " + cmd.padEnd(12) + " - " + (commands[cmd].desc || ""))
            .join("\n"));
      }
    };

    commands.echo = {
      desc: "Print to screen",
      fn(args) {
        print(args.join(" "));
      }
    };

    commands.clear = {
      desc: "Clear terminal screen",
      fn() {
        outputEl.innerHTML = "";
      }
    };

    commands.pwd = {
      desc: "Show current directory",
      fn() {
        print(fs.cwd);
      }
    };

    commands.cd = {
      desc: "Change directory",
      fn(args) {
        const path = resolvePath(args[0] || "/");
        const node = fs.getNode(path);
        if (node && typeof node === "object") {
          fs.cwd = path;
        } else {
          print(`cd: ${args[0]}: Not a directory`);
        }
      }
    };

    commands.ls = {
      desc: "List directory",
      fn(args) {
        const path = resolvePath(args[0] || ".");
        const list = fs.ls(path);
        print(list.join("  "));
      }
    };

    commands.pkg = {
      desc: "TSPOS package manager",
      fn: async (args) => {
        const sub = args[0];
        const name = args[1];

        if (sub === "install" && name) {
          const rawURL = `https://raw.githubusercontent.com/jhlbrothers2-stack/TSPOS/main/${name}`;
          try {
            const res = await fetch(rawURL);
            if (!res.ok) throw new Error("Not found");
            const js = await res.text();
            eval(js);
            fs.setNode("/" + name, js);
            print(`Installed ${name}`);
          } catch (err) {
            print(`Failed to install ${name}`);
          }
        } else {
          print("Usage: pkg install <file.js>");
        }
      }
    };

    // Run command
    async function runCommand(line) {
      print(`$ ${line}`);
      const [name, ...args] = line.trim().split(/\s+/);
      const command = commands[name];
      if (command) {
        try {
          await command.fn(args);
        } catch (e) {
          print(`Error: ${e.message}`);
        }
      } else {
        print(`Command not found: ${name}`);
      }
    }

    // Input handler
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const value = inputEl.value;
        inputEl.value = "";
        runCommand(value);
      }
    });

    // Welcome message
    print("Welcome to TSPOS Starter! Type 'help' to begin.");
  </script>
</body>
</html>
